name: Generate IMAGES.md and update README

on:
  workflow_run:
    workflows: ["Build & Push CPU/GPU Dev/Prod Images"]
    types: [completed]

permissions:
  contents: write

jobs:
  build-table:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Ensure Python deps
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-yaml

      - name: Expand matrix & generate IMAGES.md
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          # 1. Expand matrix into JSON and pipe into table generator
          matrix_json=$(./scripts/expand_matrix.py)
          echo "$matrix_json" | ./scripts/generate_table.py

      - name: Inject table into README.md
        run: |
          chmod +x scripts/inject_table.py
          scripts/inject_table.py

      - name: Commit assets/IMAGES.md and README.md
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "chore: update assets/IMAGES.md and README.md"
          file_pattern: "assets/IMAGES.md,README.md"
          branch: main
