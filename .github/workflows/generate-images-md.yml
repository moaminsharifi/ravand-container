name: Generate IMAGES.md and update README

on:
  workflow_run:
    workflows: ["Build & Push CPU/GPU Dev/Prod Images"]
    types: [completed]

permissions:
  contents: write

jobs:
  set-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.expand.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install yq & jq
        run: |
          sudo apt-get update && sudo apt-get install -y jq
          wget -qO /usr/local/bin/yq \
            https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          chmod +x /usr/local/bin/yq

      - name: Expand matrix.yaml
        id: expand
        run: |
          MATRIX=$(yq eval -o=json '
            [
              .python[] as $p |
              .extra[] as $e |
              .mode[] as $m |
              {
                python: $p,
                extra:  $e,
                mode:   $m,
                base:   .base_map[$e]
              }
            ]
          ' .github/matrix.yaml)
          {
            echo "matrix<<EOF"
            echo "${MATRIX}"
            echo "EOF"
          } >> $GITHUB_OUTPUT

  build-table:
    needs: set-matrix
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.set-matrix.outputs.matrix) }}
    steps:
      - name: Build MD table fragment
        run: |
          mkdir -p assets
          # Header only once
          if [ "${{ matrix.python }}" = "3.10" ] && \
             [ "${{ matrix.extra }}" = "cpu" ] && \
             [ "${{ matrix.mode }}" = "dev" ] && \
             [ "${{ matrix.base }}" = "debian:bullseye-slim" ]; then
            cat > assets/IMAGES.md << 'EOF'
            | Python | Variant | Mode | Base Image | Tags |
            |--------|---------|------|------------|------|
            EOF
          fi
          # Append this row
          echo "| ${{ matrix.python }} | ${{ matrix.extra }} | ${{ matrix.mode }} | ${{ matrix.base }} | ghcr.io/${{ github.repository }}:py${{ matrix.python }}-${{ matrix.extra }}-${{ matrix.mode }} |" \
            >> assets/IMAGES.md

  update-readme:
    needs: build-table
    runs-on: ubuntu-latest
    steps:
      - name: Checkout for docs update
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Insert images table into README.md
        run: |
          # Extract the content before and after the markers
          sed -n '/<!-- IMAGES_TABLE_START -->/,/<!-- IMAGES_TABLE_END -->/p' README.md > before.tmp
          sed -n '/<!-- IMAGES_TABLE_END -->/,$p' README.md > after.tmp
          # Extract only the generated table
          sed -n '/^| Python/,/^$/p' assets/IMAGES.md > table.tmp
          # Reassemble README.md with new table
          cat before.tmp table.tmp after.tmp > README.md
          rm before.tmp table.tmp after.tmp

      - name: Commit assets/IMAGES.md and README.md
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "chore: update assets/IMAGES.md and README.md"
          file_pattern: "assets/IMAGES.md,README.md"
          branch: main
